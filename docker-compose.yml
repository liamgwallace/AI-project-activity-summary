version: '3.8'

services:
  app:
    build: .
    image: ghcr.io/${GITHUB_USERNAME}/personal-activity-intelligence:latest
    container_name: activity-intelligence
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_USERNAME=${GITHUB_USERNAME}
      - CHROME_CLIENT_ID=${CHROME_CLIENT_ID}
      - CHROME_CLIENT_SECRET=${CHROME_CLIENT_SECRET}
      - CHROME_REFRESH_TOKEN=${CHROME_REFRESH_TOKEN}
      - GMAIL_CREDENTIALS_JSON=${GMAIL_CREDENTIALS_JSON}
      - GCAL_CREDENTIALS_JSON=${GCAL_CREDENTIALS_JSON}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - OBSIDIAN_PROJECT_VAULT_PATH=${OBSIDIAN_PROJECT_VAULT_PATH}
      - OBSIDIAN_PERSONAL_VAULT_PATH=${OBSIDIAN_PERSONAL_VAULT_PATH}
      - SESSION_GAP_MINUTES=${SESSION_GAP_MINUTES:-60}
      - PROCESSING_INTERVAL_HOURS=${PROCESSING_INTERVAL_HOURS:-6}
      - MAX_CONTEXT_CHARS=${MAX_CONTEXT_CHARS:-50000}
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      - ./logs:/app/logs
      - ${OBSIDIAN_PROJECT_VAULT_PATH}:${OBSIDIAN_PROJECT_VAULT_PATH}
      - ${OBSIDIAN_PERSONAL_VAULT_PATH}:${OBSIDIAN_PERSONAL_VAULT_PATH}
      - ${MONITORED_PATHS}:${MONITORED_PATHS}:ro
    depends_on:
      - neo4j

  neo4j:
    image: neo4j:5.15
    container_name: activity-neo4j
    restart: unless-stopped
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data

volumes:
  neo4j_data:
